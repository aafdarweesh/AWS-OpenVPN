# Clients Relations
in this project I will have one super-client that is able to access the internet, can access the other clients
but the other clients cannot access him (one direction relation)

## Clients IP-addresses
List of client that I used in my experiement
```
ifconfig-push 10.8.0.10 10.8.0.11
ifconfig-push 10.8.0.15 10.8.0.16
ifconfig-push 10.8.0.20 10.8.0.21
ifconfig-push 10.8.0.25 10.8.0.26
ifconfig-push 10.8.0.30 10.8.0.31
ifconfig-push 10.8.0.40 10.8.0.41
```

## Server configurations
these modifications will be made in the server configuration file
```
sudo su
cd /etc/openvpn
nano server.conf
```
make sure that the next line is commented:
```
;topology subnet
```

that's it for this file as you followed the previous configurations "main configurations" and "static-IPs configurations"

## Iptables

here will be the main work.
from here we will allow only one user to access the other users.
for any connection it should be bidirectional, but here we will say that in case that the connection start from that user
then accept it, otherwise drop

as from previous configurations you have the server in ip : 10.8.0.1 

### 1 ) you can either remove the file and reassign the settings and continue
```
rm /etc/iptables/rules.v4
nano /etc/iptables/rules.v4
```
the content of the file 

```
# Generated by iptables-save v1.6.0 on Wed Aug 23 12:05:34 2017
*nat
:PREROUTING ACCEPT [1:60]
:INPUT ACCEPT [1:60]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:AS0_NAT - [0:0]
:AS0_NAT_POST_REL_EST - [0:0]
:AS0_NAT_PRE - [0:0]
:AS0_NAT_PRE_REL_EST - [0:0]
:AS0_NAT_TEST - [0:0]
-A PREROUTING -m state --state RELATED,ESTABLISHED -j AS0_NAT_PRE_REL_EST
-A POSTROUTING -m state --state RELATED,ESTABLISHED -j AS0_NAT_POST_REL_EST
-A POSTROUTING -m mark --mark 0x2000000/0x2000000 -j AS0_NAT_PRE
-A POSTROUTING -d 10.8.0.0/24 -j SNAT --to-source 10.8.0.1
-A POSTROUTING -s 10.8.0.10/32 -o eth0 -j MASQUERADE
-A AS0_NAT -j MASQUERADE
-A AS0_NAT_POST_REL_EST -j ACCEPT
-A AS0_NAT_PRE -m mark --mark 0x8000000/0x8000000 -j AS0_NAT
-A AS0_NAT_PRE -d 169.254.0.0/16 -j AS0_NAT_TEST
-A AS0_NAT_PRE -d 192.168.0.0/16 -j AS0_NAT_TEST
-A AS0_NAT_PRE -d 172.16.0.0/12 -j AS0_NAT_TEST
-A AS0_NAT_PRE -d 10.0.0.0/8 -j AS0_NAT_TEST
-A AS0_NAT_PRE -j AS0_NAT
-A AS0_NAT_PRE_REL_EST -j ACCEPT
-A AS0_NAT_TEST -o as0t+ -j ACCEPT
-A AS0_NAT_TEST -m mark --mark 0x4000000/0x4000000 -j ACCEPT
-A AS0_NAT_TEST -d 172.27.224.0/20 -j ACCEPT
-A AS0_NAT_TEST -j AS0_NAT
COMMIT
# Completed on Wed Aug 23 12:05:34 2017
# Generated by iptables-save v1.6.0 on Wed Aug 23 12:05:34 2017
*mangle
:PREROUTING ACCEPT [1:60]
:INPUT ACCEPT [36:2207]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [27:20720]
:POSTROUTING ACCEPT [27:20720]
:AS0_MANGLE_PRE_REL_EST - [0:0]
:AS0_MANGLE_TUN - [0:0]
-A PREROUTING -m state --state RELATED,ESTABLISHED -j AS0_MANGLE_PRE_REL_EST
-A PREROUTING -i as0t+ -j AS0_MANGLE_TUN
-A AS0_MANGLE_PRE_REL_EST -j ACCEPT
-A AS0_MANGLE_TUN -j MARK --set-xmark 0x2000000/0xffffffff
-A AS0_MANGLE_TUN -j ACCEPT
COMMIT
# Completed on Wed Aug 23 12:05:34 2017
# Generated by iptables-save v1.6.0 on Wed Aug 23 12:05:34 2017
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -s 127.0.0.0/8 ! -i lo -j REJECT --reject-with icmp-port-unreachable
-A INPUT -p icmp -m state --state NEW -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -p icmp -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i eth0 -p tcp -m state --state NEW,ESTABLISHED -m tcp --dport 22 -j ACCEPT
-A INPUT -i eth0 -p tcp -m state --state NEW,ESTABLISHED -m tcp --dport 5333 -j ACCEPT
-A INPUT -i eth0 -p tcp -m state --state NEW,ESTABLISHED -m tcp --dport 80 -j ACCEPT
-A INPUT -i eth0 -p udp -m state --state ESTABLISHED -m udp --sport 53 -j ACCEPT
-A INPUT -i eth0 -p tcp -m state --state ESTABLISHED -m tcp --sport 53 -j ACCEPT
-A INPUT -i eth0 -p tcp -m state --state ESTABLISHED -m tcp --sport 80 -j ACCEPT
-A INPUT -i eth0 -p tcp -m state --state ESTABLISHED -m tcp --sport 443 -j ACCEPT
-A INPUT -i tun0 -j ACCEPT
-A INPUT -m limit --limit 3/min -j LOG --log-prefix "iptables_INPUT_denied: "
-A INPUT -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.15/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.20/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.25/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.30/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.35/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.40/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -i tun0 -o eth0 -j ACCEPT
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m limit --limit 3/min -j LOG --log-prefix "iptables_FORWARD_denied: "
-A FORWARD -i tun0 -j DROP
-A FORWARD -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -p icmp -j ACCEPT
-A OUTPUT -o eth0 -p tcp -m state --state ESTABLISHED -m tcp --sport 22 -j ACCEPT
-A OUTPUT -o eth0 -p tcp -m state --state ESTABLISHED -m tcp --sport 5333 -j ACCEPT
-A OUTPUT -o eth0 -p tcp -m state --state ESTABLISHED -m tcp --sport 80 -j ACCEPT
-A OUTPUT -o eth0 -p udp -m state --state NEW,ESTABLISHED -m udp --dport 53 -j ACCEPT
-A OUTPUT -o eth0 -p tcp -m state --state NEW,ESTABLISHED -m tcp --dport 53 -j ACCEPT
-A OUTPUT -o eth0 -p tcp -m state --state NEW,ESTABLISHED -m tcp --dport 80 -j ACCEPT
-A OUTPUT -o eth0 -p tcp -m state --state NEW,ESTABLISHED -m tcp --dport 443 -j ACCEPT
-A OUTPUT -o tun0 -j ACCEPT
-A OUTPUT -m limit --limit 3/min -j LOG --log-prefix "iptables_OUTPUT_denied: "
-A OUTPUT -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Wed Aug 23 12:05:34 2017

```
### 2 ) or just write the next lines in the file
```
-A POSTROUTING -s 10.8.0.10/32 -o eth0 -j MASQUERADE
#make sure that it is not 10.8.0.0/24 as the above line for only one user

-A FORWARD -s 10.8.0.10/32 -d 10.8.0.15/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.20/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.25/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.30/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.35/32 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -s 10.8.0.10/32 -d 10.8.0.40/32 -m conntrack --ctstate NEW -j ACCEPT
#these lines to allow 10.8.0.10 client to access the other clients only if it start by 10.8.0.10 client 
# you can also put 10.8.0.0/24 for the receiver (client) which means for all the users in 10.8.0.0/24 subnet

-A FORWARD -i tun0 -j DROP
#to make sure that will be no other connection only from 10.8.0.10 that will be accepted
```


## Other files that must be edited
firstly I disabled ufw (there is no need for it), you can write all settings using iptables

```
ufw disable
```
in the next file /etc/default/ufw

```
nano /etc/default/ufw
```
make sure of the valuez assigned for the next lines:
```
DEFAULT_INPUT_POLICY="ACCEPT"
DEFAULT_OUTPUT_POLICY="ACCEPT"
DEFAULT_FORWARD_POLICY="DROP"

MANAGE_BUILTINS=no
#this one is the most important one as caused many problems while I was using ufw and iptables
```

for the next file /etc/sysctl.conf
```
nano /etc/sysctl.conf 
```
inside the file make sure of the next lines are commented 
```
#net/ipv4/ip_forward=1
#net/ipv6/conf/default/forwarding=1
#net/ipv6/conf/all/forwarding=1
```

for all files setting you can follow this link (containing the files and the changes)
```
https://docs.google.com/document/d/1PB9X9t4baepvZc9ZmQOADzboiA585cB_J9VfjM5UJ_s/edit
```

### Test
now if you want to test (I did and recommend)
test it using linux and non-linux systems it will be better ti make sure that your system is working proparly

## Some links that will help
```
https://openvpn.net/index.php/open-source/documentation/howto.html#policy
https://www.linode.com/docs/networking/vpn/tunnel-your-internet-traffic-through-an-openvpn-server

Using route:
http://backreference.org/2010/05/02/controlling-client-to-client-connections-in-openvpn/

Using bridge:
http://backreference.org/2010/06/18/openvpns-built-in-packet-filter/

```

## Contributions
Stackoverflow
Google 
OpenVPN (the least)
Internet 
(Ofcourse joking, just forget about it)

## Authors

* **Ahmed Darwish** - *Initial work* - [PurpleBooth](https://github.com/aafdarweesh)

## License

JUST HAVE FUN !!!
## Acknowledgments

* GOOD LUCK !!!
